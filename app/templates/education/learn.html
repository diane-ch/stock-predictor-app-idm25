<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Learning Hub</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/learn.css') }}">
  <script>
  // Make the static URL available to external JavaScript
  window.STATIC_LESSONS_URL = "{{ url_for('static', filename='images/lessons/') }}";
  </script>
  <script src="{{ url_for('static', filename='js/learn.js') }}"></script>
</head>
<body>

  <div class="main-wrapper">

      <div class="top-header">
      <h2>Your learning path</h2>
      <div class="menu-wrapper">
        <div class="menu-icon" onclick="toggleMenu()">⋮</div>
          <div class="logout-menu" id="logoutMenu">
              <a href="{{ url_for('auth.logout') }}" class="logout-button">
              <span class="logout-text">Log Out</span>
              <img src="{{ url_for('static', filename='images/logout.png') }}" class="logout-icon" alt="logout arrow" />
              </a>

            <div class="menu-divider"></div>
            <!-- Tutorial -->
            <button class="menu-item" id="tutorialBtn">
              <span class="menu-text">Tutorial</span>
              <img src="../../static/images/Tutoriallogo.png" class="menu-icon-right" alt="Tutorial Icon" />
            </button>


          <div class="menu-divider"></div>
            <!-- Terms -->
            <button class="menu-item" id="termsBtn">
              <span class="menu-text">Terms & Privacy</span>
              <img src="../../static/images/termslogo.png" class="menu-icon-right" alt="Terms Icon" />
            </button>
          </div>
        </div>
    </div>

    <!-- 学习进度文字 + 横线 -->
    <div class="progress-line-wrapper">
      <div class="progress-text">📚 
        {% set total_completed_lessons = modules_data | sum(attribute='progress.completed_lessons', start=0) %}
        {% set total_lessons = modules_data | sum(attribute='progress.total_lessons', start=0) %}
        {{ total_completed_lessons }}/{{ total_lessons }} Completed
      </div>
      <hr class="progress-line" />
    </div>


    <!-- 可滚动内容区域 -->
    <div class="scrollable-content">
      <div class="content-placeholder">

        {% for module_data in modules_data %}
        <div class="learning-card">
          <div class="card-top">
            <img src="{{ url_for('static', filename='images/' + module_data.module['icon']) }}" alt="avatar" class="card-avatar" />
            <div class="card-info">
              <div class="card-title">
                {{ module_data.module['emoji'] }} <strong>{{ module_data.module['title'] }}</strong>
              </div>
              <div class="card-subtitle">{{ module_data.module['description'] }}</div>
            </div>
            {% if module_data.status == "locked" %}
              <div class="card-status" style="background-color: #ccc;">🔒 Locked</div>
            {% elif module_data.status == "completed" %}
              <div class="card-status" style="background-color: #4CAF50;">🎉 Completed</div>
            {% elif module_data.status == "available" %}
              <div class="card-status" style="background-color: #2196F3;">📚 Available</div>
            {% endif %}
          </div>
          
          <div class="card-stars">
            {% for lesson_circle in module_data.lesson_circles %}
              <div class="star-circle 
                  {% if lesson_circle.is_unlocked %}
                    {% if lesson_circle.is_completed %}
                      completed-circle
                    {% else %}
                      learning-circle
                    {% endif %}
                  {% else %}
                    gray-circle
                  {% endif %}"
                  {% if lesson_circle.is_unlocked %}
                    onclick="openVideoCard('{{ module_data.module.id }}', '{{ lesson_circle.lesson_id }}')"
                  {% endif %}>
                
                {% if lesson_circle.is_completed %}
                  <img src="{{ url_for('static', filename='images/star.png') }}" alt="star" />
                {% else %}
                  {{ loop.index }}
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>
        {% endfor %}

      </div>
    </div>

      <nav class="bottom-nav">
    <a href="{{ url_for('main.ai_predictions') }}" class="nav-item">
      <img src="../../static/images/predictions-inactive.png" alt="AI Predictions">
      <span>AI Predictions</span>
    </a>
    <a href="{{ url_for('main.discover') }}" class="nav-item">
      <img src="../../static/images/discover-inactive.png" alt="Disc#f5f6f7over">
      <span>Discover</span>
    </a>
    <a href="{{ url_for('main.learning')}}" class="nav-item active">
      <img src="../../static/images/learn-active.png" alt="Learn">
      <span>Learn</span>
    </a>
  </nav>


  </div>

  
<div class="video-popup-overlay" id="videoPopup">
  <div class="video-popup-card">
    <div class="video-popup-header">
      <div class="popup-badge" id="popupCategory"></div>
      <div class="popup-badge" id="popupTime"></div>
    </div>

    <img src="" alt="lesson" class="lesson-image" id="popupImage" />

    <div class="lesson-title" id="popupTitle"></div>
    <div class="lesson-desc" id="popupDesc"></div>

    <div class="start-btn-container">
      <div class="start-divider"></div>
      <button class="start-btn" id="startLearningBtn" onclick="startLesson()">Start Learning</button>
    </div>
  </div>
</div>


<!-- Tutorial Modal（大弹窗） -->
<div class="modal-overlay" id="tutorialModal">
  <div class="modal-card">
    <h3 class="modal-title">What you need to know about your Smart Picks</h3>

    <p class="modal-sub">
      In here you will find daily digest of the top five predictions or pick of stocks for the day.
      <br>New picks every 24 hours
    </p>

    <!-- 1) 日期/倒计时示意图（替换为你的图片） -->
    <figure class="tutorial-figure">
      <img src="../../static/images/tutorial-date.png" alt="date example" class="tutorial-img">
    </figure>

    <p class="modal-desc">
      Each pick includes: The name of the stock, the price and percentage of change that is predicted for the end of the day, and a confidence score
    </p>

    <!-- 2) 股票卡片示意图 -->
    <figure class="tutorial-figure">
      <img src="../../static/images/tutorial-card.png" alt="card example" class="tutorial-img">
    </figure>

    <p class="modal-desc">
      Whenever you see this icon you will know that this was an AI prediction and the level of confidence it has
    </p>

    <!-- 3) 置信度示意图 -->
    <figure class="tutorial-figure">
      <img src="../../static/images/tutorial-confidence.png" alt="confidence example" class="tutorial-img">
    </figure>

    <p class="modal-desc">
      You can see more details on the stock picks like the features taken into consideration for each prediction
    </p>

    <button class="modal-close" id="tutorialCloseBtn">Close</button>
  </div>
</div>
  


<script>
  // Make the static URL available first
  window.STATIC_LESSONS_URL = "{{ url_for('static', filename='images/lessons/') }}";
  
  console.log("🚀 Inline script started");
  
  let currentModuleId = null;
  let currentLessonId = null;

  function toggleMenu() {
    const menu = document.getElementById('logoutMenu');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
  }

  function openVideoCard(moduleId, lessonId) {
    currentModuleId = moduleId;
    currentLessonId = lessonId;
    
    fetch(`/education/lesson/${moduleId}/${lessonId}/preview`)
      .then(response => response.json())
      .then(data => {
        document.getElementById('popupCategory').textContent = `${data.module.emoji} ${data.module.title}`;
        document.getElementById('popupTime').textContent = `${data.lesson.duration} min`;
        document.getElementById('popupTitle').textContent = data.lesson.title;
        document.getElementById('popupDesc').textContent = data.lesson.description;
        
        let imagePreview = 'default.png';
        if (data.lesson && data.lesson['image-preview']) {
          imagePreview = data.lesson['image-preview'];
        } else if (data.lesson && data.lesson.image_preview) {
          imagePreview = data.lesson.image_preview;
        }
        
        const imageSrc = window.STATIC_LESSONS_URL + imagePreview;
        document.getElementById('popupImage').src = imageSrc;
        document.getElementById('videoPopup').style.display = 'flex';
      })
      .catch(error => {
        console.error('Error fetching lesson data:', error);
        document.getElementById('popupCategory').textContent = "🌱 Foundations";
        document.getElementById('popupTime').textContent = "8 min";
        document.getElementById('popupTitle').textContent = "Loading...";
        document.getElementById('popupDesc').textContent = "Loading lesson details...";
        document.getElementById('videoPopup').style.display = 'flex';
      });
  }

  function startLesson() {
    if (currentModuleId && currentLessonId) {
      document.getElementById('videoPopup').style.display = 'none';
      window.location.href = `/education/lesson/${currentModuleId}/${currentLessonId}/start`;
    } else {
      alert('Please select a lesson first.');
    }
  }

  // Close menu when clicking outside
  document.addEventListener("click", function(event) {
    const menu = document.getElementById("logoutMenu");
    const icon = document.querySelector(".menu-icon");
    if (menu && icon && !menu.contains(event.target) && !icon.contains(event.target)) {
      menu.style.display = "none";
    }
  });

  // Make functions global
  window.toggleMenu = toggleMenu;
  window.openVideoCard = openVideoCard;
  window.startLesson = startLesson;

  // Wait for DOM to be ready
  document.addEventListener('DOMContentLoaded', function() {
    console.log("📋 DOM ready!");
    
    // Video popup
    const popup = document.getElementById('videoPopup');
    if (popup) {
      popup.addEventListener('click', function(e) {
        if (e.target === this) {
          this.style.display = 'none';
        }
      });
    }

    // Tutorial functionality
    const tutorialBtn = document.getElementById("tutorialBtn");
    const tutorialModal = document.getElementById("tutorialModal");
    const tutorialCloseBtn = document.getElementById("tutorialCloseBtn");
    
    console.log("Tutorial elements found:", {
      button: !!tutorialBtn,
      modal: !!tutorialModal,
      closeBtn: !!tutorialCloseBtn
    });

    if (tutorialBtn && tutorialModal) {
      tutorialBtn.addEventListener("click", function (e) {
        console.log("🎯 Tutorial button clicked!");
        e.preventDefault();
        e.stopPropagation();
        
        // Show modal
        tutorialModal.style.display = "flex";
        
        // Hide menu
        const logoutMenu = document.getElementById("logoutMenu");
        if (logoutMenu) logoutMenu.style.display = "none";
        
        console.log("✅ Tutorial modal shown");
      });
    }

    if (tutorialCloseBtn && tutorialModal) {
      tutorialCloseBtn.addEventListener("click", function () {
        console.log("🔄 Close button clicked");
        tutorialModal.style.display = "none";
      });
    }

    if (tutorialModal) {
      tutorialModal.addEventListener("click", function (e) {
        if (e.target === tutorialModal) {
          tutorialModal.style.display = "none";
        }
      });
    }
  });
  
  console.log("🏁 Inline script loaded");
</script>


</body>
</html>
